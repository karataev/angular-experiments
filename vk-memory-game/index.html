<!DOCTYPE html>
<html ng-app="app">
<head lang="en">
    <meta charset="UTF-8">
    <title></title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>

    <style>
        .my-input-group {
            /*width: 800px;*/
        }

        .panel-default {
            padding: 10px;
        }

        .friend-avatar {
            display: inline-block;
            width: 100px;
            height: 100px;
            margin-left: 5px;
            margin-bottom: 5px;
        }

    </style>

</head>
<body ng-controller="MainCtrl as ctrl">

<div class="container">
    <ava-options></ava-options>
    <div>
        <img ng-repeat="pic in ctrl.pics" ng-src="{{pic}}" alt=""/>
    </div>
</div>

<script src="//vk.com/js/api/openapi.js" type="text/javascript"></script>
<script>VK.init({apiId: 4937981});</script>


<script>
    var app = angular.module("app", []);

    app.controller("MainCtrl", function ($scope, $rootScope) {

        var vm = this;
        vm.pics = undefined;

        $rootScope.$on('updateAvas', function (e, pics) {
            vm.pics = pics;
            $scope.$apply();
        })

    })

    app.directive("avaOptions", function () {
        return {
            controller: function ($scope, avaService, $rootScope) {
                var vm = this;
                vm.uid = 1;
                vm.amount = 3;
                vm.hideEmpty = true;
                vm.friends = undefined;

                this.searchClick = function () {
                    //avaService.hello();
                    avaService.getAvas(vm.uid, vm.amount, vm.hideEmpty, function (pics) {
                        $rootScope.$broadcast('updateAvas', pics)
                    });
                }

            },
            controllerAs:'getCtrl',
            replace:true,
            templateUrl:'tmpl/get-avatars.html'
        }
    })

    app.factory("avaService", function ($rootScope) {
        var hello = function () {
            console.log("Hi! I'm service");
        }

        var getAvas = function (uid, amount, hideEmpty, callback) {
            VK.Api.call("friends.get", {user_id:uid, order:'random', fields:'photo_100', count:amount}, function (r) {
                if (r.response) {
                    var friends = r.response;

                    if (hideEmpty) {
                        friends = friends.filter(function (x) {
                            //console.log(x.photo_100);
                            return !x.deactivated && !(x.photo_100 === 'https://vk.com/images/camera_100.png');
                        })
                    }

                    var pics = friends.map(function (x) {
                        return x.photo_100;
                    })
                    callback(pics);
                }
            })
        }

        return {
            hello:hello,
            getAvas:getAvas
        }
    })

</script>

</body>
</html>