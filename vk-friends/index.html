<!DOCTYPE html>
<html ng-app="app">
<head lang="en">
    <meta charset="UTF-8">
    <title></title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>

    <style>
        .my-input-group {
            width: 800px;
        }

        .my-input-group input[type='text'] {
            width: 100px;
        }

        .panel-default {
            padding: 10px;
        }

        .friend-avatar {
            display: inline-block;
            width: 100px;
            height: 100px;
            margin-left: 5px;
            margin-bottom: 5px;
        }

    </style>

</head>
<body ng-controller="MainCtrl">

<div class="container">
    <h1>Get VK User's Friends</h1>

    <form class="form-inline">
        <div class="well my-input-group">
            <label for="userId">User ID</label>
            <input type="text" id="userId" class="form-control" ng-model="idToFind"/>
            <label for="numFriends">Number of friends</label>
            <input type="text" id="numFriends" ng-model="numFriends" class="form-control"/>
            <button type="submit" class="btn btn-default" ng-click="search()">Get</button>
        </div>
    </form>
    <div class="panel panel-default" ng-if="friends">
        <h2>{{user.first_name}} {{user.last_name}}. Друзья. {{friends.length}}</h2>
        <friend-avatar ng-repeat="friend in friends"></friend-avatar>
    </div>
</div>



<script src="//vk.com/js/api/openapi.js" type="text/javascript"></script>
<script>
    VK.init({
        apiId: 4937981
    });
</script>

<script>

    var app = angular.module("app", []);

    app.controller("MainCtrl", function ($scope) {

        $scope.idToFind = 1;
        $scope.numFriends = 10;
        $scope.user = undefined;
        $scope.friends = undefined;


        $scope.search = function () {
            getUser($scope.idToFind);
            getFriends($scope.idToFind, $scope.numFriends);
        }

        var getUser = function (uid) {
            VK.Api.call('users.get', {uids: uid, fields:"photo_100"}, function(r) {
                if(r.response) {
                    $scope.user = r.response[0];
                    $scope.$apply();
                }
            });
        }

        var getFriends = function (uid, amount) {
            VK.Api.call("friends.get", {user_id:uid, order:'random', fields:'photo_100', count:amount}, function (r) {
                if (r.response) {
                    //console.log("!", r.response);
                    $scope.friends = r.response;
                    $scope.$apply();
                }
            })
        }
        //$scope.search();

        $scope.login = function () {
            VK.Auth.login(function(response) {
                if (response.session) {
                    console.log("success");

                    /* Пользователь успешно авторизовался */
                    if (response.settings) {
                        /* Выбранные настройки доступа пользователя, если они были запрошены */
                    }
                } else {
                    console.log("cancel");
                    /* Пользователь нажал кнопку Отмена в окне авторизации */
                }
            });
        }

    })

    app.directive("friendAvatar", function () {
        return {
            link: function (scope, el, attrs) {
                var title = scope.friend.first_name + " " + scope.friend.last_name;
                el.tooltip({
                    title:title
                })
            },
            replace:true,
            templateUrl:'tmpl/friend-avatar.html'
        }
    })


</script>

</body>
</html>